<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' https://cdnjs.cloudflare.com; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:; connect-src 'self' https://script.google.com https://script.googleusercontent.com https://accounts.google.com; frame-ancestors 'self'">
    <title>Расчет трафика - AIAdminka</title>
    <link rel="stylesheet" href="css/traffic-calculation.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"
            integrity="sha512-r22gChDnGvBylk90+2e/ycr3RVrDi8DIOkIGNhJlKfuyQM4tIRAI062MaV8sfjQKYVGjOBaZBOA87z+IhZE9DA=="
            crossorigin="anonymous"
            referrerpolicy="no-referrer"></script>
</head>
<body>
    <div class="app-container">
        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <button class="back-button" onclick="trafficCalc.toggleSidebar()">
                <img src="icons/arrow.svg" width="30" height="30" alt="Toggle">
            </button>

            <div class="sidebar-menu">
                <div class="menu-item" onclick="window.location.href='../index.html'">
                    <span>Главная</span>
                    <img src="icons/main_page.svg" width="20" height="20" alt="Главная">
                </div>

                <div class="menu-item" onclick="window.location.href='../excel-reports/index.html'">
                    <span>Отчеты</span>
                    <img src="icons/excel_reports.svg" width="20" height="20" alt="Отчеты">
                </div>

                <div class="menu-item" onclick="window.location.href='../team-info/index.html'">
                    <span>Сотрудники</span>
                    <img src="icons/team_info.svg" width="20" height="20" alt="Сотрудники">
                </div>

                <div class="menu-item active">
                    <span>Расчет трафика</span>
                    <img src="icons/Traffic calculation.svg" width="20" height="20" alt="Трафик">
                </div>

                <div class="menu-item" onclick="window.location.href='../partners/index.html'">
                    <span>Партнеры</span>
                    <img src="icons/partners.svg" width="20" height="20" alt="Партнеры">
                </div>

                <div class="menu-item" onclick="window.location.href='../documentation/index.html'">
                    <span>Документация</span>
                    <img src="icons/documents.svg" width="20" height="20" alt="Документация">
                </div>

                <div class="menu-item" onclick="window.location.href='../sync/index.html'">
                    <span>Настройки</span>
                    <img src="icons/sync.svg" width="20" height="20" alt="Настройки">
                </div>
            </div>

            <div class="menu-separator"></div>

            <div class="version-info" onclick="showAboutModal()">
                <span class="version-text-full">О разработке</span>
                <span id="versionText" class="version-number"></span>
                <span class="version-icon" title="О разработке">
                    <img src="../shared/icons/info.svg" alt="О разработке">
                </span>
            </div>
        </aside>

        <script>
            (function() {
                const sidebar = document.getElementById('sidebar');
                sidebar.classList.add('no-transition');
                if (localStorage.getItem('sidebar-collapsed') === 'true') {
                    sidebar.classList.add('collapsed');
                }
                requestAnimationFrame(function() {
                    requestAnimationFrame(function() {
                        sidebar.classList.remove('no-transition');
                    });
                });
            })();
        </script>

        <!-- Main wrapper -->
        <div class="main-wrapper">
            <!-- Global header -->
            <header class="global-header">
                <div class="header-title">Расчет трафика</div>
            </header>

            <!-- Content area -->
            <div class="content-area">
                <!-- Tabs -->
                <div class="tabs-container">
                    <button class="tab-btn active" onclick="trafficCalc.switchTab('analytics')">
                        <img src="icons/filter.svg" alt="">
                        Аналитика
                    </button>
                    <button class="tab-btn" onclick="trafficCalc.switchTab('report')">
                        <img src="icons/documents.svg" alt="">
                        Отчет
                    </button>
                </div>

                <!-- Tab: Аналитика -->
                <div id="analyticsTab" class="tab-content active">
                    <!-- Steps indicator -->
                    <div class="steps-container">
                        <div class="steps-indicator">
                            <div class="step active" data-step="1" onclick="trafficCalc.navigateToStep(1)">
                                <div class="step-number">1</div>
                                <div class="step-title">Выбор партнеров</div>
                            </div>
                            <div class="step" data-step="2" onclick="trafficCalc.navigateToStep(2)">
                                <div class="step-number">2</div>
                                <div class="step-title">Пополнения и выводы</div>
                            </div>
                            <div class="step" data-step="3" onclick="trafficCalc.navigateToStep(3)">
                                <div class="step-number">3</div>
                                <div class="step-title">Контроль качества</div>
                            </div>
                            <div class="step" data-step="4" onclick="trafficCalc.navigateToStep(4)">
                                <div class="step-number">4</div>
                                <div class="step-title">% Времени работы</div>
                            </div>
                            <div class="step" data-step="5" onclick="trafficCalc.navigateToStep(5)">
                                <div class="step-number">5</div>
                                <div class="step-title">Автоотключения</div>
                            </div>
                            <div class="step" data-step="6" onclick="trafficCalc.navigateToStep(6)">
                                <div class="step-number">6</div>
                                <div class="step-title">Нарушения</div>
                            </div>
                        </div>
                    </div>

                    <!-- Step 1: Выбор партнеров -->
                    <div id="step1" class="analytics-step active">
                        <div class="main-section" style="flex: 1; display: flex; flex-direction: column;">
                            <div class="section-header">
                                <div class="section-title">Шаг 1: Выбор партнеров для анализа</div>
                                <div class="section-actions">
                                    <button class="btn-reset" onclick="trafficCalc.confirmResetAnalytics()" title="Сбросить все данные аналитики">
                                        <img src="icons/cross.svg" alt="">
                                        <span>Сбросить всё</span>
                                    </button>
                                </div>
                            </div>
                            <div class="section-body" style="flex: 1; display: flex; flex-direction: column;">

                                <!-- Toolbar с кнопками выбора (скрыт до загрузки данных) -->
                                <div id="selectionToolbar" class="selection-toolbar" style="display: none;">
                                    <div class="toolbar-group">
                                        <span class="toolbar-label">Выбрать:</span>
                                        <button class="toolbar-btn" onclick="trafficCalc.selectAll()" title="Выбрать всех партнёров">
                                            <img src="icons/done.svg" alt="">
                                            <span>Всех</span>
                                        </button>
                                        <button class="toolbar-btn" onclick="trafficCalc.showMethodSelection()" title="Выбрать по методу работы">
                                            <img src="icons/filter.svg" alt="">
                                            <span>По методу</span>
                                        </button>
                                        <button class="toolbar-btn" onclick="trafficCalc.showManualSelection()" title="Выбрать вручную">
                                            <img src="icons/pen.svg" alt="">
                                            <span>Вручную</span>
                                        </button>
                                    </div>
                                    <div class="toolbar-group">
                                        <button class="toolbar-btn toolbar-btn-clear" onclick="trafficCalc.clearSelection()" title="Очистить выбор">
                                            <img src="icons/cross.svg" alt="">
                                            <span>Очистить</span>
                                        </button>
                                    </div>
                                </div>

                                <!-- Спиннер загрузки -->
                                <div id="loadingSpinner" class="loading-spinner">
                                    <div class="spinner"></div>
                                    <div class="loading-text">Загрузка партнёров...</div>
                                </div>

                                <!-- Подсказка: нет партнёров -->
                                <div id="noPartnersHint" class="no-partners-hint" style="display: none;">
                                    <img src="icons/partners.svg" alt="" class="no-partners-hint-icon">
                                    <div class="no-partners-hint-text">Нет партнёров для анализа</div>
                                    <div class="no-partners-hint-subtext">Сначала добавьте партнёров на вкладке "Партнёры"</div>
                                    <a href="../partners/index.html" class="no-partners-hint-link">
                                        <img src="icons/partners.svg" alt="">
                                        Перейти к партнёрам
                                    </a>
                                </div>

                                <!-- Панель выбора по методу -->
                                <div id="methodSelectionPanel" class="selection-panel-modern" style="display: none;">
                                    <div class="panel-header">
                                        <h3>Выберите методы</h3>
                                        <button class="panel-close" onclick="trafficCalc.hideAllPanels()">
                                            <img src="icons/cross.svg" alt="Закрыть">
                                        </button>
                                    </div>
                                    <div id="methodCheckboxes" class="checkbox-grid"></div>
                                    <div class="panel-actions">
                                        <button class="btn btn-secondary" onclick="trafficCalc.hideAllPanels()">Отмена</button>
                                        <button class="btn btn-primary" onclick="trafficCalc.applyMethodSelection()">
                                            <img src="icons/done.svg" alt="" style="filter: brightness(0) invert(1);">
                                            Применить
                                        </button>
                                    </div>
                                </div>

                                <!-- Панель ручного выбора -->
                                <div id="manualSelectionPanel" class="selection-panel-modern" style="display: none;">
                                    <div class="panel-header">
                                        <h3>Выберите партнеров</h3>
                                        <button class="panel-close" onclick="trafficCalc.hideAllPanels()">
                                            <img src="icons/cross.svg" alt="Закрыть">
                                        </button>
                                    </div>
                                    <div id="partnerCheckboxes" class="checkbox-grid"></div>
                                    <div class="panel-actions">
                                        <button class="btn btn-secondary" onclick="trafficCalc.hideAllPanels()">Отмена</button>
                                        <button class="btn btn-primary" onclick="trafficCalc.applyManualSelection()">
                                            <img src="icons/done.svg" alt="" style="filter: brightness(0) invert(1);">
                                            Применить
                                        </button>
                                    </div>
                                </div>

                                <!-- Таблица выбранных партнёров (скрыта до загрузки данных) -->
                                <div class="partners-preview" style="display: none;">
                                    <div class="preview-header">
                                        <span class="preview-title">Выбранные партнёры</span>
                                        <span class="partner-count-badge" id="selectedCount">0</span>
                                    </div>
                                    <div class="table-container" style="flex: 1;">
                                        <table class="data-table">
                                            <thead>
                                                <tr>
                                                    <th>Метод</th>
                                                    <th>Субагент</th>
                                                    <th>Субагент ID</th>
                                                    <th>Статус</th>
                                                </tr>
                                            </thead>
                                            <tbody id="selectedPartnersTableBody">
                                                <tr>
                                                    <td colspan="4" class="empty-state">Партнеры не выбраны</td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>

                            </div>
                            <!-- Навигация (вне section-body для постоянной видимости) -->
                            <div class="step-navigation-modern">
                                <div></div>
                                <button id="step1NextBtn" class="nav-btn nav-btn-next" onclick="trafficCalc.goToStep(2)" disabled>
                                    <span>Далее</span>
                                    <img src="icons/arrow.svg" alt="">
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Step 2: Пополнения и выводы -->
                    <div id="step2" class="analytics-step">
                        <div class="main-section" style="flex: 1;">
                            <div class="section-header">
                                <div class="section-title">Шаг 2: Пополнения и выводы</div>
                                <div class="section-actions">
                                    <button class="btn-reset" onclick="trafficCalc.resetDepositsData()" title="Сбросить данные пополнений и выводов">
                                        <img src="icons/cross.svg" alt="">
                                        <span>Сбросить</span>
                                    </button>
                                </div>
                            </div>
                            <div class="section-body">
                                <div class="step-hint">
                                    <img src="icons/filter.svg" alt="">
                                    <span>Загрузите Excel-файлы с данными о пополнениях и выводах для подсчета "back" и "cringe"</span>
                                </div>

                                <div class="upload-zone" onclick="document.getElementById('depositsFileInput').click()">
                                    <img src="icons/import.svg" class="upload-zone-icon" alt="">
                                    <div class="upload-zone-text">Перетащите файлы сюда</div>
                                    <div class="upload-zone-hint">или нажмите для выбора (.xlsx)</div>
                                    <input type="file" id="depositsFileInput" accept=".xlsx" multiple style="display: none;" onchange="trafficCalc.handleDepositsUpload(event)">
                                </div>
                                <div id="depositsStatus" class="upload-status"></div>
                            </div>
                            <!-- Навигация (вне section-body для постоянной видимости) -->
                            <div class="step-navigation-modern">
                                <button class="nav-btn nav-btn-back" onclick="trafficCalc.goToStep(1)">
                                    <img src="icons/arrow.svg" alt="">
                                    <span>Назад</span>
                                </button>
                                <button id="step2NextBtn" class="nav-btn nav-btn-next" onclick="trafficCalc.goToStep(3)" disabled>
                                    <span>Далее</span>
                                    <img src="icons/arrow.svg" alt="">
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Step 3: Контроль качества -->
                    <div id="step3" class="analytics-step">
                        <div class="main-section" style="flex: 1;">
                            <div class="section-header">
                                <div class="section-title">Шаг 3: Контроль качества</div>
                                <div class="section-actions">
                                    <button class="btn-reset" onclick="trafficCalc.resetQualityData()" title="Сбросить данные контроля качества">
                                        <img src="icons/cross.svg" alt="">
                                        <span>Сбросить</span>
                                    </button>
                                </div>
                            </div>
                            <div class="section-body">
                                <div class="step-hint">
                                    <img src="icons/filter.svg" alt="">
                                    <span>Загрузите Excel-файлы с данными о контроле качества работы</span>
                                </div>

                                <div class="upload-zone" onclick="document.getElementById('qualityFileInput').click()">
                                    <img src="icons/import.svg" class="upload-zone-icon" alt="">
                                    <div class="upload-zone-text">Перетащите файлы сюда</div>
                                    <div class="upload-zone-hint">или нажмите для выбора (.xlsx)</div>
                                    <input type="file" id="qualityFileInput" accept=".xlsx" multiple style="display: none;" onchange="trafficCalc.handleQualityUpload(event)">
                                </div>
                                <div id="qualityStatus" class="upload-status"></div>
                            </div>
                            <!-- Навигация (вне section-body для постоянной видимости) -->
                            <div class="step-navigation-modern">
                                <button class="nav-btn nav-btn-back" onclick="trafficCalc.goToStep(2)">
                                    <img src="icons/arrow.svg" alt="">
                                    <span>Назад</span>
                                </button>
                                <button id="step3NextBtn" class="nav-btn nav-btn-next" onclick="trafficCalc.goToStep(4)" disabled>
                                    <span>Далее</span>
                                    <img src="icons/arrow.svg" alt="">
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Step 4: % Времени работы -->
                    <div id="step4" class="analytics-step">
                        <div class="main-section" style="flex: 1;">
                            <div class="section-header">
                                <div class="section-title">Шаг 4: % Времени работы</div>
                                <div class="section-actions">
                                    <button class="btn-reset" onclick="trafficCalc.resetAllWorkTimeData()" title="Сбросить все данные по времени работы">
                                        <img src="icons/cross.svg" alt="">
                                        <span>Сбросить</span>
                                    </button>
                                </div>
                            </div>
                            <div class="section-body">
                                <div class="step-hint">
                                    <img src="icons/pen.svg" alt="">
                                    <span>Выберите субагента слева и укажите % времени работы</span>
                                </div>

                                <div class="worktime-layout">
                                    <!-- Левая колонка: выбор субагента -->
                                    <div class="worktime-selector">
                                        <div class="form-group">
                                            <label for="partnerSearchInput">Поиск</label>
                                            <input type="text" id="partnerSearchInput" placeholder="Поиск..." oninput="trafficCalc.filterPartnersList()">
                                        </div>
                                        <div class="form-group">
                                            <label for="partnerSelectList">Субагент</label>
                                            <select id="partnerSelectList" size="8" onchange="trafficCalc.loadPartnerManualData()">
                                                <option value="">Выберите на шаге 1</option>
                                            </select>
                                        </div>
                                    </div>

                                    <!-- Правая колонка: форма времени работы -->
                                    <div class="worktime-form-container">
                                        <div id="manualDataForm" style="display: none;">
                                            <div class="worktime-form-header">
                                                <h3 class="worktime-form-title">% Времени: <span id="selectedPartnerName"></span></h3>
                                                <button class="btn-reset btn-reset-small" onclick="trafficCalc.resetWorkTimeData()" title="Сбросить">
                                                    <img src="icons/cross.svg" alt="">
                                                    <span>Сбросить</span>
                                                </button>
                                            </div>

                                            <div class="worktime-grid">
                                                <div class="worktime-item">
                                                    <span class="worktime-label">На пополнения</span>
                                                    <div class="worktime-input-group">
                                                        <input type="number" id="depositWorkTimePercent" value="0" min="0" max="100" onchange="trafficCalc.saveCurrentManualData()">
                                                        <span class="percent-sign">%</span>
                                                    </div>
                                                </div>
                                                <div class="worktime-item">
                                                    <span class="worktime-label">На вывод</span>
                                                    <div class="worktime-input-group">
                                                        <input type="number" id="withdrawalWorkTimePercent" value="0" min="0" max="100" onchange="trafficCalc.saveCurrentManualData()">
                                                        <span class="percent-sign">%</span>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <!-- Навигация (вне section-body для постоянной видимости) -->
                            <div class="step-navigation-modern">
                                <button class="nav-btn nav-btn-back" onclick="trafficCalc.goToStep(3)">
                                    <img src="icons/arrow.svg" alt="">
                                    <span>Назад</span>
                                </button>
                                <button id="step4NextBtn" class="nav-btn nav-btn-next" onclick="trafficCalc.goToStep(5)" disabled>
                                    <span>Далее</span>
                                    <img src="icons/arrow.svg" alt="">
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Step 5: Автоотключения -->
                    <div id="step5" class="analytics-step">
                        <div class="main-section" style="flex: 1;">
                            <div class="section-header">
                                <div class="section-title">Шаг 5: Автоотключения</div>
                                <div class="section-actions">
                                    <button class="btn-reset" onclick="trafficCalc.resetPercentData()" title="Сбросить данные автоотключений">
                                        <img src="icons/cross.svg" alt="">
                                        <span>Сбросить</span>
                                    </button>
                                </div>
                            </div>
                            <div class="section-body">
                                <div class="step-hint">
                                    <img src="icons/filter.svg" alt="">
                                    <span>Загрузите Excel-файлы с данными о процентовках для подсчета автоотключений</span>
                                </div>

                                <div class="upload-zone" onclick="document.getElementById('percentFileInput').click()">
                                    <img src="icons/import.svg" class="upload-zone-icon" alt="">
                                    <div class="upload-zone-text">Перетащите файлы сюда</div>
                                    <div class="upload-zone-hint">или нажмите для выбора (.xlsx)</div>
                                    <input type="file" id="percentFileInput" accept=".xlsx" multiple style="display: none;" onchange="trafficCalc.handlePercentUpload(event)">
                                </div>
                                <div id="percentStatus" class="upload-status"></div>
                            </div>
                            <!-- Навигация (вне section-body для постоянной видимости) -->
                            <div class="step-navigation-modern">
                                <button class="nav-btn nav-btn-back" onclick="trafficCalc.goToStep(4)">
                                    <img src="icons/arrow.svg" alt="">
                                    <span>Назад</span>
                                </button>
                                <button id="step5NextBtn" class="nav-btn nav-btn-next" onclick="trafficCalc.goToStep(6)" disabled>
                                    <span>Далее</span>
                                    <img src="icons/arrow.svg" alt="">
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Step 6: Нарушения -->
                    <div id="step6" class="analytics-step">
                        <div class="main-section" style="flex: 1;">
                            <div class="section-header">
                                <div class="section-title">Шаг 6: Нарушения</div>
                                <div class="section-actions">
                                    <button class="btn-reset" onclick="trafficCalc.resetAllViolationsData()" title="Сбросить все данные по нарушениям">
                                        <img src="icons/cross.svg" alt="">
                                        <span>Сбросить</span>
                                    </button>
                                </div>
                            </div>
                            <div class="section-body">
                                <div class="step-hint">
                                    <img src="icons/pen.svg" alt="">
                                    <span>Выберите субагента слева и укажите данные по нарушениям. Этот шаг опционален.</span>
                                </div>

                                <div class="violations-layout">
                                    <!-- Левая колонка: выбор субагента -->
                                    <div class="violations-selector">
                                        <div class="form-group">
                                            <label for="partnerSearchInput6">Поиск</label>
                                            <input type="text" id="partnerSearchInput6" placeholder="Поиск..." oninput="trafficCalc.filterPartnersListStep6()">
                                        </div>
                                        <div class="form-group">
                                            <label for="partnerSelectList6">Субагент</label>
                                            <select id="partnerSelectList6" size="8" onchange="trafficCalc.loadPartnerManualDataStep6()">
                                                <option value="">Выберите на шаге 1</option>
                                            </select>
                                        </div>
                                    </div>

                                    <!-- Правая колонка: форма нарушений -->
                                    <div class="violations-form-container">
                                        <div id="manualDataForm6" style="display: none;">
                                            <div class="violations-form-header">
                                                <h3 class="violations-form-title">Нарушения: <span id="selectedPartnerName6"></span></h3>
                                                <button class="btn-reset btn-reset-small" onclick="trafficCalc.resetViolationsData()" title="Сбросить">
                                                    <img src="icons/cross.svg" alt="">
                                                    <span>Сбросить</span>
                                                </button>
                                            </div>

                                            <div class="violations-grid">
                                                <div class="violation-item">
                                                    <span class="violation-label">Игнорирование чатов</span>
                                                    <div class="number-input-group">
                                                        <button type="button" class="btn-icon" onclick="trafficCalc.decrementManualValue('chatIgnoring')">
                                                            <img src="../shared/icons/minus.svg" alt="-">
                                                        </button>
                                                        <input type="number" id="chatIgnoring" value="0" min="0" onchange="trafficCalc.saveCurrentManualDataStep6()">
                                                        <button type="button" class="btn-icon" onclick="trafficCalc.incrementManualValue('chatIgnoring')">
                                                            <img src="icons/plus.svg" alt="+">
                                                        </button>
                                                    </div>
                                                </div>
                                                <div class="violation-item">
                                                    <span class="violation-label">Игнор Webmanagement</span>
                                                    <div class="number-input-group">
                                                        <button type="button" class="btn-icon" onclick="trafficCalc.decrementManualValue('webmanagementIgnore')">
                                                            <img src="../shared/icons/minus.svg" alt="-">
                                                        </button>
                                                        <input type="number" id="webmanagementIgnore" value="0" min="0" onchange="trafficCalc.saveCurrentManualDataStep6()">
                                                        <button type="button" class="btn-icon" onclick="trafficCalc.incrementManualValue('webmanagementIgnore')">
                                                            <img src="icons/plus.svg" alt="+">
                                                        </button>
                                                    </div>
                                                </div>
                                                <div class="violation-item">
                                                    <span class="violation-label">Очереди на пополнение</span>
                                                    <div class="number-input-group">
                                                        <button type="button" class="btn-icon" onclick="trafficCalc.decrementManualValue('depositQueues')">
                                                            <img src="../shared/icons/minus.svg" alt="-">
                                                        </button>
                                                        <input type="number" id="depositQueues" value="0" min="0" onchange="trafficCalc.saveCurrentManualDataStep6()">
                                                        <button type="button" class="btn-icon" onclick="trafficCalc.incrementManualValue('depositQueues')">
                                                            <img src="icons/plus.svg" alt="+">
                                                        </button>
                                                    </div>
                                                </div>
                                                <div class="violation-item">
                                                    <span class="violation-label">Очереди на вывод</span>
                                                    <div class="number-input-group">
                                                        <button type="button" class="btn-icon" onclick="trafficCalc.decrementManualValue('withdrawalQueues')">
                                                            <img src="../shared/icons/minus.svg" alt="-">
                                                        </button>
                                                        <input type="number" id="withdrawalQueues" value="0" min="0" onchange="trafficCalc.saveCurrentManualDataStep6()">
                                                        <button type="button" class="btn-icon" onclick="trafficCalc.incrementManualValue('withdrawalQueues')">
                                                            <img src="icons/plus.svg" alt="+">
                                                        </button>
                                                    </div>
                                                </div>
                                                <div class="violation-item">
                                                    <span class="violation-label">Зачисление вне лимитов</span>
                                                    <div class="number-input-group">
                                                        <button type="button" class="btn-icon" onclick="trafficCalc.decrementManualValue('creditsOutsideLimits')">
                                                            <img src="../shared/icons/minus.svg" alt="-">
                                                        </button>
                                                        <input type="number" id="creditsOutsideLimits" value="0" min="0" onchange="trafficCalc.saveCurrentManualDataStep6()">
                                                        <button type="button" class="btn-icon" onclick="trafficCalc.incrementManualValue('creditsOutsideLimits')">
                                                            <img src="icons/plus.svg" alt="+">
                                                        </button>
                                                    </div>
                                                </div>
                                                <div class="violation-item">
                                                    <span class="violation-label">Одобрение неверной суммы</span>
                                                    <div class="number-input-group">
                                                        <button type="button" class="btn-icon" onclick="trafficCalc.decrementManualValue('wrongAmountApproval')">
                                                            <img src="../shared/icons/minus.svg" alt="-">
                                                        </button>
                                                        <input type="number" id="wrongAmountApproval" value="0" min="0" onchange="trafficCalc.saveCurrentManualDataStep6()">
                                                        <button type="button" class="btn-icon" onclick="trafficCalc.incrementManualValue('wrongAmountApproval')">
                                                            <img src="icons/plus.svg" alt="+">
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>

                                            <div class="other-violations-section">
                                                <div class="other-violations-header">
                                                    <span class="violation-label">Другие нарушения</span>
                                                    <div class="number-input-group">
                                                        <button type="button" class="btn-icon" onclick="trafficCalc.decrementManualValue('otherViolations')">
                                                            <img src="../shared/icons/minus.svg" alt="-">
                                                        </button>
                                                        <input type="number" id="otherViolations" value="0" min="0" onchange="trafficCalc.saveCurrentManualDataStep6()">
                                                        <button type="button" class="btn-icon" onclick="trafficCalc.incrementManualValue('otherViolations')">
                                                            <img src="icons/plus.svg" alt="+">
                                                        </button>
                                                    </div>
                                                </div>
                                                <textarea id="otherViolationsDescription" class="violations-description-large" placeholder="Опишите нарушения подробно..." onchange="trafficCalc.saveCurrentManualDataStep6()"></textarea>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <!-- Навигация (вне section-body для постоянной видимости) -->
                            <div class="step-navigation-modern">
                                <button class="nav-btn nav-btn-back" onclick="trafficCalc.goToStep(5)">
                                    <img src="icons/arrow.svg" alt="">
                                    <span>Назад</span>
                                </button>
                                <button id="step6NextBtn" class="nav-btn nav-btn-complete" onclick="trafficCalc.completeAnalytics()">
                                    <img src="icons/done.svg" alt="">
                                    <span>Завершить</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Tab: Отчет -->
                <div id="reportTab" class="tab-content">
                    <div class="main-section" style="flex: 1; display: flex; flex-direction: column;">
                        <div class="section-header">
                            <div class="section-title">Формирование отчета</div>
                            <div class="section-actions">
                                <button class="btn btn-primary" onclick="trafficCalc.generateReport()">
                                    <img src="icons/documents.svg" alt="" style="filter: brightness(0) invert(1);">
                                    Сформировать отчет
                                </button>
                            </div>
                        </div>
                        <div class="section-body" style="flex: 1; display: flex; flex-direction: column;">
                            <div id="reportNotGenerated" class="report-placeholder">
                                <div class="report-placeholder-content">
                                    <img src="icons/documents.svg" alt="">
                                    <p>Отчет не сформирован</p>
                                    <p class="report-hint">Перейдите на вкладку "Аналитика", выберите партнеров и вернитесь сюда для формирования отчета</p>
                                </div>
                            </div>

                            <div id="reportGenerated" class="report-generated" style="display: none;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                                    <span style="font-size: 14px; font-weight: 700; color: var(--black);">Детальный отчет</span>
                                    <div style="display: flex; gap: 8px;">
                                        <button class="btn btn-success" onclick="trafficCalc.exportReportToExcel()">
                                            <img src="icons/export.svg" alt="">
                                            Экспорт в Excel
                                        </button>
                                        <button class="btn btn-primary" onclick="trafficCalc.openTrafficCalculator()">
                                            <img src="icons/settings.svg" alt="" style="filter: brightness(0) invert(1);">
                                            Рассчитать % трафика
                                        </button>
                                    </div>
                                </div>

                                <div class="table-container" style="flex: 1;">
                                    <table class="data-table">
                                        <thead>
                                            <tr>
                                                <th>Метод</th>
                                                <th>Субагент</th>
                                                <th>Субагент ID</th>
                                                <th>Статус</th>
                                                <th>Дата добавления</th>
                                                <th>Back</th>
                                                <th>Cringe</th>
                                                <th>Автоотключение</th>
                                                <th>Кол-во пополнений</th>
                                                <th>Кол-во выводов</th>
                                                <th>Обращений по пополнениям</th>
                                                <th>Обращения 15+ мин</th>
                                                <th>% успешных пополнений</th>
                                                <th>% успешных выводов</th>
                                                <th>% Времени работы на пополнения</th>
                                                <th>% Времени работы на вывод</th>
                                                <th>Игнорирование чатов</th>
                                                <th>Игнор Webmanagement</th>
                                                <th>Очереди на пополнение</th>
                                                <th>Очереди на вывод</th>
                                                <th>Зачисление вне лимитов</th>
                                                <th>Одобрение неверной суммы</th>
                                                <th>Другие нарушения</th>
                                            </tr>
                                        </thead>
                                        <tbody id="reportTableBody">
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal: Traffic Calculator -->
    <div id="trafficCalculatorModal" class="modal modal-xlarge">
        <div class="modal-dialog">
            <div class="modal-header">
                <h2>Настройки расчета % трафика</h2>
                <button class="modal-close" onclick="trafficCalc.closeTrafficCalculator()">
                    <img src="icons/cross.svg" alt="Закрыть">
                </button>
            </div>
            <div class="modal-body">
                <div class="modal-description-row">
                    <p class="modal-description">Укажите диапазоны и баллы. Чем больше баллов — тем меньше % трафика.</p>
                    <button class="help-toggle-btn" onclick="trafficCalc.toggleHelp()">
                        <img src="../shared/icons/info.svg" alt="Справка">
                        Справка
                    </button>
                </div>

                <div id="trafficHelpContent" class="traffic-help-content" style="display: none;">
                    <h4>Формула расчета % трафика</h4>
                    <p><strong>Общий балл партнёра</strong> = сумма баллов по всем параметрам</p>
                    <p>Каждый параметр имеет 4 уровня оценки:</p>
                    <ul>
                        <li><span class="score-good">Хороший</span> — лучший результат, минимальные баллы</li>
                        <li><span class="score-normal">Нормальный</span> — приемлемый результат</li>
                        <li><span class="score-bad">Плохой</span> — результат ниже нормы</li>
                        <li><span class="score-terrible">Ужасный</span> — критически плохой результат</li>
                    </ul>
                    <p><strong>Как заполнять настройки:</strong></p>
                    <ul>
                        <li>Для каждого параметра укажите диапазон значений (от-до)</li>
                        <li>Укажите количество баллов за попадание в этот диапазон</li>
                        <li>Чем больше баллов — тем хуже результат партнёра</li>
                    </ul>
                    <p><strong>Как рассчитывается % трафика:</strong></p>
                    <ul>
                        <li>Партнёры группируются по методу работы</li>
                        <li>Внутри каждого метода распределяется 100% трафика</li>
                        <li>Трафик распределяется обратно пропорционально баллам</li>
                        <li>Чем больше баллов (хуже работа) — тем меньше % трафика</li>
                    </ul>
                    <p><strong>Пример:</strong> В методе 2 партнёра с баллами 10 и 30. Первый (меньше баллов, лучше) получит 75%, второй (больше баллов, хуже) — 25%.</p>
                </div>

                <div id="trafficSettingsForm" class="traffic-settings-form">
                </div>
            </div>
            <div class="modal-footer" style="justify-content: space-between;">
                <div style="display: flex; gap: 6px;">
                    <button class="btn btn-small btn-warning" onclick="trafficCalc.exportTrafficSettings()">
                        <img src="icons/export.svg" alt="">
                        Экспорт
                    </button>
                    <button class="btn btn-small btn-secondary" onclick="trafficCalc.importTrafficSettings()">
                        <img src="icons/import.svg" alt="">
                        Импорт
                    </button>
                </div>
                <div style="display: flex; gap: 6px;">
                    <button class="btn btn-small btn-secondary" onclick="trafficCalc.closeTrafficCalculator()">Отмена</button>
                    <button class="btn btn-success" onclick="trafficCalc.calculateTraffic()">
                        <img src="icons/done.svg" alt="">
                        Рассчитать
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal: Traffic Results -->
    <div id="trafficResultsModal" class="modal modal-large">
        <div class="modal-dialog">
            <div class="modal-header">
                <h2>Результаты расчета % трафика</h2>
                <button class="modal-close" onclick="trafficCalc.closeTrafficResults()">
                    <img src="icons/cross.svg" alt="Закрыть">
                </button>
            </div>
            <div class="modal-body">
                <div class="table-container">
                    <table class="data-table traffic-results-table">
                        <thead>
                            <tr>
                                <th>Метод</th>
                                <th>Субагент</th>
                                <th>ID Субагента</th>
                                <th class="score-good">Хороший</th>
                                <th class="score-normal">Нормальный</th>
                                <th class="score-bad">Плохой</th>
                                <th class="score-terrible">Ужасный</th>
                                <th class="score-total">Всего</th>
                                <th class="traffic-percent-header">% Трафика</th>
                            </tr>
                        </thead>
                        <tbody id="trafficResultsTableBody">
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="trafficCalc.closeTrafficResults()">Закрыть</button>
                <button class="btn btn-success" onclick="trafficCalc.exportTrafficResults()">
                    <img src="icons/export.svg" alt="">
                    Экспорт в Excel
                </button>
            </div>
        </div>
    </div>

    <!-- About Modal -->
    <div class="modal" id="aboutModal">
        <div class="modal-dialog">
            <div class="modal-header">
                <h2 class="modal-title">О разработке</h2>
                <button class="modal-close" onclick="closeAboutModal()">
                    <img src="icons/cross.svg" width="24" height="24" alt="Закрыть">
                </button>
            </div>
            <div class="modal-body">
                <p>Это проект <strong>Vadim P</strong></p>
                <p>Reddy ID для связи: <strong>62219492522</strong></p>
                <p>Ссылка на чат с актуальной версией:<br>
                <a href="https://lnk.reddy.team/invite/sp9ugcdOP7mIzmLSWZNocYCffj5enUB_" target="_blank">https://lnk.reddy.team/invite/sp9ugcdOP7mIzmLSWZNocYCffj5enUB_</a></p>
            </div>
        </div>
    </div>

    <script src="../shared/version.js"></script>
    <script src="../shared/storage.js"></script>
    <script src="../shared/cloud-storage.js"></script>
    <script src="../shared/sync-manager.js"></script>
    <script src="../shared/auth-guard.js"></script>
    <script src="js/storage.js"></script>
    <script src="js/traffic-calculation.js"></script>
    <script>
        function showAboutModal() {
            document.getElementById('aboutModal').classList.add('active');
        }
        function closeAboutModal() {
            document.getElementById('aboutModal').classList.remove('active');
        }
        document.getElementById('aboutModal').addEventListener('click', function(e) {
            if (e.target === this) closeAboutModal();
        });
    </script>
</body>
</html>
