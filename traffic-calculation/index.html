<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Расчет трафика - Windows XP</title>
    <link rel="stylesheet" href="../css/xp-module.css">
    <link rel="stylesheet" href="css/traffic-calculation.css">
    <script src="https://unpkg.com/lucide@0.548.0/dist/umd/lucide.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body>
    <div class="container">
        <nav>
            <a href="../index.html">← Главная</a>
        </nav>
        
        <header>
            <h1><i data-lucide="trending-up"></i> Расчет трафика</h1>
            <p>Управление партнерами и аналитика</p>
        </header>

        <!-- Вкладки -->
        <div class="tabs">
            <button class="tab-btn active" onclick="trafficCalc.switchTab('partners')">
                <i data-lucide="users"></i> Управление партнерами
            </button>
            <button class="tab-btn" onclick="trafficCalc.switchTab('analytics')">
                <i data-lucide="bar-chart"></i> Аналитика
            </button>
            <button class="tab-btn" onclick="trafficCalc.switchTab('report')">
                <i data-lucide="file-text"></i> Отчет
            </button>
        </div>

        <!-- Вкладка: Управление партнерами -->
        <div id="partnersTab" class="tab-content active">
            <div class="section">
                <h2>Добавить партнера</h2>
                <form id="partnerForm" class="partner-form">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="methodSelect">Метод</label>
                            <div class="method-input-wrapper">
                                <select id="methodSelect" required>
                                    <option value="">Выберите метод</option>
                                </select>
                                <button type="button" class="btn-icon" onclick="trafficCalc.showMethodModal()" title="Управление методами">
                                    <i data-lucide="settings"></i>
                                </button>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="subagentInput">Субагент</label>
                            <input type="text" id="subagentInput" placeholder="Название субагента" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="subagentIdInput">Субагент ID</label>
                            <input type="text" id="subagentIdInput" placeholder="ID субагента" required>
                        </div>
                    </div>
                    
                    <button type="submit" class="btn btn-primary">
                        <i data-lucide="plus"></i> Добавить партнера
                    </button>
                </form>
            </div>

            <div class="section">
                <div class="section-header">
                    <h2>Список партнеров</h2>
                    <div class="filter-controls">
                        <select id="methodFilter" onchange="trafficCalc.filterPartners()">
                            <option value="">Все методы</option>
                        </select>
                        <button class="btn btn-success" onclick="trafficCalc.exportPartners()" title="Экспортировать список партнеров">
                            <i data-lucide="download"></i> Экспорт
                        </button>
                        <button class="btn btn-warning" onclick="trafficCalc.showImportModal()" title="Импортировать список партнеров">
                            <i data-lucide="upload"></i> Импорт
                        </button>
                        <span class="partner-count">Всего: <strong id="partnerCount">0</strong></span>
                    </div>
                </div>
                
                <div class="table-wrapper">
                    <table class="partners-table">
                        <thead>
                            <tr>
                                <th>Метод</th>
                                <th>Субагент</th>
                                <th>Субагент ID</th>
                                <th>Статус</th>
                                <th>Дата добавления</th>
                                <th>Действия</th>
                            </tr>
                        </thead>
                        <tbody id="partnersTableBody">
                            <tr>
                                <td colspan="6" class="empty-state">Партнеры не добавлены</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Вкладка: Аналитика -->
        <div id="analyticsTab" class="tab-content">
            <!-- Индикатор шагов -->
            <div class="steps-indicator">
                <div class="step active clickable" data-step="1" onclick="trafficCalc.navigateToStep(1)">
                    <div class="step-number">1</div>
                    <div class="step-title">Выбор партнеров</div>
                </div>
                <div class="step clickable" data-step="2" onclick="trafficCalc.navigateToStep(2)">
                    <div class="step-number">2</div>
                    <div class="step-title">Пополнения и выводы</div>
                </div>
                <div class="step clickable" data-step="3" onclick="trafficCalc.navigateToStep(3)">
                    <div class="step-number">3</div>
                    <div class="step-title">Контроль качества</div>
                </div>
                <div class="step clickable" data-step="4" onclick="trafficCalc.navigateToStep(4)">
                    <div class="step-number">4</div>
                    <div class="step-title">% Времени работы</div>
                </div>
                <div class="step clickable" data-step="5" onclick="trafficCalc.navigateToStep(5)">
                    <div class="step-number">5</div>
                    <div class="step-title">Автоотключения</div>
                </div>
                <div class="step clickable" data-step="6" onclick="trafficCalc.navigateToStep(6)">
                    <div class="step-number">6</div>
                    <div class="step-title">Нарушения</div>
                </div>
            </div>

            <!-- Шаг 1: Выбор партнеров -->
            <div id="step1" class="analytics-step active">
                <div class="section">
                    <h2>Шаг 1: Выбор партнеров для анализа</h2>
                    
                    <div class="selection-controls">
                        <button class="btn btn-secondary" onclick="trafficCalc.selectAll()">
                            <i data-lucide="check-square"></i> Все
                        </button>
                        <button class="btn btn-secondary" onclick="trafficCalc.showMethodSelection()">
                            <i data-lucide="filter"></i> По методу
                        </button>
                        <button class="btn btn-secondary" onclick="trafficCalc.showManualSelection()">
                            <i data-lucide="mouse-pointer"></i> Выборочно
                        </button>
                        <button class="btn btn-secondary" onclick="trafficCalc.clearSelection()">
                            <i data-lucide="x"></i> Очистить выбор
                        </button>
                        <button class="btn btn-danger" onclick="trafficCalc.confirmResetAnalytics()" style="margin-left: auto;">
                            <i data-lucide="rotate-ccw"></i> Сбросить всё
                        </button>
                    </div>

                    <!-- Панель выбора по методу -->
                    <div id="methodSelectionPanel" class="selection-panel" style="display: none;">
                        <h3>Выберите методы</h3>
                        <div id="methodCheckboxes" class="checkbox-group"></div>
                        <button class="btn btn-primary" onclick="trafficCalc.applyMethodSelection()">Применить</button>
                    </div>

                    <!-- Панель ручного выбора -->
                    <div id="manualSelectionPanel" class="selection-panel" style="display: none;">
                        <h3>Выберите партнеров</h3>
                        <div id="partnerCheckboxes" class="checkbox-group"></div>
                        <button class="btn btn-primary" onclick="trafficCalc.applyManualSelection()">Применить</button>
                    </div>
                </div>

                <div class="section">
                    <div class="section-header">
                        <h2>Предпросмотр выбранных партнеров</h2>
                        <span class="partner-count">Выбрано: <strong id="selectedCount">0</strong></span>
                    </div>
                    
                    <div class="table-wrapper">
                        <table class="partners-table">
                            <thead>
                                <tr>
                                    <th>Метод</th>
                                    <th>Субагент</th>
                                    <th>Субагент ID</th>
                                    <th>Статус</th>
                                </tr>
                            </thead>
                            <tbody id="selectedPartnersTableBody">
                                <tr>
                                    <td colspan="4" class="empty-state">Партнеры не выбраны</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <div class="step-navigation">
                        <button id="step1NextBtn" class="btn btn-primary" onclick="trafficCalc.goToStep(2)" disabled>
                            Далее <i data-lucide="arrow-right"></i>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Шаг 2: Пополнения и выводы (обязательный) -->
            <div id="step2" class="analytics-step">
                <div class="section">
                    <h2>Шаг 2: Загрузка отчета "Пополнения и выводы" <span class="required-badge">Обязательный</span></h2>
                    <p class="step-description">Загрузите файлы с данными о пополнениях и выводах для подсчета комментариев "back" и "cringe"</p>
                    
                    <div class="file-upload-section">
                        <label for="depositsFileInput" class="btn btn-secondary">
                            <i data-lucide="upload"></i> Загрузить файлы
                        </label>
                        <input type="file" id="depositsFileInput" accept=".xlsx" multiple style="display: none;" onchange="trafficCalc.handleDepositsUpload(event)">
                        <div id="depositsStatus" class="upload-status"></div>
                    </div>

                    <div class="step-navigation">
                        <button class="btn btn-secondary" onclick="trafficCalc.goToStep(1)">
                            <i data-lucide="arrow-left"></i> Назад
                        </button>
                        <button id="step2NextBtn" class="btn btn-primary" onclick="trafficCalc.goToStep(3)" disabled>
                            Далее <i data-lucide="arrow-right"></i>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Шаг 3: Контроль качества (обязательный) -->
            <div id="step3" class="analytics-step">
                <div class="section">
                    <h2>Шаг 3: Загрузка отчета "Контроль качества работы" <span class="required-badge">Обязательный</span></h2>
                    <p class="step-description">Загрузите файлы с данными о контроле качества</p>
                    
                    <div class="file-upload-section">
                        <label for="qualityFileInput" class="btn btn-secondary">
                            <i data-lucide="upload"></i> Загрузить файлы
                        </label>
                        <input type="file" id="qualityFileInput" accept=".xlsx" multiple style="display: none;" onchange="trafficCalc.handleQualityUpload(event)">
                        <div id="qualityStatus" class="upload-status"></div>
                    </div>

                    <div class="step-navigation">
                        <button class="btn btn-secondary" onclick="trafficCalc.goToStep(2)">
                            <i data-lucide="arrow-left"></i> Назад
                        </button>
                        <button id="step3NextBtn" class="btn btn-primary" onclick="trafficCalc.goToStep(4)" disabled>
                            Далее <i data-lucide="arrow-right"></i>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Шаг 4: % Времени работы (обязательный) -->
            <div id="step4" class="analytics-step">
                <div class="section">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                        <div>
                            <h2 style="margin: 0 0 4px 0;">Шаг 4: % Времени работы <span class="required-badge">Обязательный</span></h2>
                            <p class="step-description" style="margin: 0;">Выберите субагента и укажите процент времени работы на пополнения и вывод</p>
                        </div>
                        <button class="btn btn-danger" onclick="trafficCalc.resetAllWorkTimeData()" title="Сбросить данные для всех субагентов">
                            <i data-lucide="rotate-ccw"></i> Сбросить всё
                        </button>
                    </div>

                    <div class="manual-data-layout">
                        <!-- Левая часть: Форма с данными -->
                        <div class="manual-data-form-container">
                            <div id="manualDataForm" style="display: none;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                                    <h3 style="margin: 0;">Данные по времени работы: <span id="selectedPartnerName"></span></h3>
                                    <button class="btn btn-danger btn-small" onclick="trafficCalc.resetWorkTimeData()">
                                        <i data-lucide="rotate-ccw"></i> Сбросить
                                    </button>
                                </div>

                                <div class="table-wrapper">
                                    <table class="partners-table manual-data-table">
                                        <thead>
                                            <tr>
                                                <th>Параметр</th>
                                                <th>Значение</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr>
                                                <td>% Времени работы на пополнения</td>
                                                <td>
                                                    <div class="number-input-group">
                                                        <input type="number" id="depositWorkTimePercent" value="0" min="0" max="100" placeholder="%" onchange="trafficCalc.saveCurrentManualData()">
                                                        <span class="percent-label">%</span>
                                                    </div>
                                                </td>
                                            </tr>
                                            <tr>
                                                <td>% Времени работы на вывод</td>
                                                <td>
                                                    <div class="number-input-group">
                                                        <input type="number" id="withdrawalWorkTimePercent" value="0" min="0" max="100" placeholder="%" onchange="trafficCalc.saveCurrentManualData()">
                                                        <span class="percent-label">%</span>
                                                    </div>
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>

                        <!-- Правая часть: Выбор субагента -->
                        <div class="manual-data-selector">
                            <div class="form-group">
                                <label for="partnerSearchInput">Поиск субагента</label>
                                <input type="text" id="partnerSearchInput" placeholder="Введите название субагента" oninput="trafficCalc.filterPartnersList()">
                            </div>

                            <div class="form-group">
                                <label for="partnerSelectList">Выберите субагента</label>
                                <select id="partnerSelectList" size="10" onchange="trafficCalc.loadPartnerManualData()">
                                    <option value="">Сначала выберите партнеров на шаге 1</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="step-navigation">
                        <button class="btn btn-secondary" onclick="trafficCalc.goToStep(3)">
                            <i data-lucide="arrow-left"></i> Назад
                        </button>
                        <button id="step4NextBtn" class="btn btn-primary" onclick="trafficCalc.goToStep(5)" disabled>
                            Далее <i data-lucide="arrow-right"></i>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Шаг 5: Автоотключения (обязательный) -->
            <div id="step5" class="analytics-step">
                <div class="section">
                    <h2>Шаг 5: Загрузка отчета "Автоотключения" <span class="required-badge">Обязательный</span></h2>
                    <p class="step-description">Загрузите файлы с данными о процентовках для подсчета автоотключений</p>

                    <div class="file-upload-section">
                        <label for="percentFileInput" class="btn btn-secondary">
                            <i data-lucide="upload"></i> Загрузить файлы
                        </label>
                        <input type="file" id="percentFileInput" accept=".xlsx" multiple style="display: none;" onchange="trafficCalc.handlePercentUpload(event)">
                        <div id="percentStatus" class="upload-status"></div>
                    </div>

                    <div class="step-navigation">
                        <button class="btn btn-secondary" onclick="trafficCalc.goToStep(4)">
                            <i data-lucide="arrow-left"></i> Назад
                        </button>
                        <button id="step5NextBtn" class="btn btn-primary" onclick="trafficCalc.goToStep(6)" disabled>
                            Далее <i data-lucide="arrow-right"></i>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Шаг 6: Нарушения -->
            <div id="step6" class="analytics-step">
                <div class="section">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                        <div>
                            <h2 style="margin: 0 0 4px 0;">Шаг 6: Нарушения</h2>
                            <p class="step-description" style="margin: 0;">Выберите субагента и укажите ручные данные по нарушениям</p>
                        </div>
                        <button class="btn btn-danger" onclick="trafficCalc.resetAllViolationsData()" title="Сбросить данные для всех субагентов">
                            <i data-lucide="rotate-ccw"></i> Сбросить всё
                        </button>
                    </div>

                    <div class="manual-data-layout">
                        <!-- Левая часть: Форма с данными -->
                        <div class="manual-data-form-container">
                            <div id="manualDataForm6" style="display: none;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                                    <h3 style="margin: 0;">Данные по нарушениям: <span id="selectedPartnerName6"></span></h3>
                                    <button class="btn btn-danger btn-small" onclick="trafficCalc.resetViolationsData()">
                                        <i data-lucide="rotate-ccw"></i> Сбросить
                                    </button>
                                </div>

                                <div class="table-wrapper">
                                    <table class="partners-table manual-data-table">
                                        <thead>
                                            <tr>
                                                <th>Нарушение</th>
                                                <th>Количество</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr>
                                                <td>Игнорирование чатов</td>
                                                <td>
                                                    <div class="number-input-group">
                                                        <button type="button" class="btn-icon" onclick="trafficCalc.decrementManualValue('chatIgnoring')">
                                                            <i data-lucide="minus"></i>
                                                        </button>
                                                        <input type="number" id="chatIgnoring" value="0" min="0" onchange="trafficCalc.saveCurrentManualDataStep6()">
                                                        <button type="button" class="btn-icon" onclick="trafficCalc.incrementManualValue('chatIgnoring')">
                                                            <i data-lucide="plus"></i>
                                                        </button>
                                                    </div>
                                                </td>
                                            </tr>
                                            <tr>
                                                <td>Игнор Webmanagement</td>
                                                <td>
                                                    <div class="number-input-group">
                                                        <button type="button" class="btn-icon" onclick="trafficCalc.decrementManualValue('webmanagementIgnore')">
                                                            <i data-lucide="minus"></i>
                                                        </button>
                                                        <input type="number" id="webmanagementIgnore" value="0" min="0" onchange="trafficCalc.saveCurrentManualDataStep6()">
                                                        <button type="button" class="btn-icon" onclick="trafficCalc.incrementManualValue('webmanagementIgnore')">
                                                            <i data-lucide="plus"></i>
                                                        </button>
                                                    </div>
                                                </td>
                                            </tr>
                                            <tr>
                                                <td>Очереди на пополнение</td>
                                                <td>
                                                    <div class="number-input-group">
                                                        <button type="button" class="btn-icon" onclick="trafficCalc.decrementManualValue('depositQueues')">
                                                            <i data-lucide="minus"></i>
                                                        </button>
                                                        <input type="number" id="depositQueues" value="0" min="0" onchange="trafficCalc.saveCurrentManualDataStep6()">
                                                        <button type="button" class="btn-icon" onclick="trafficCalc.incrementManualValue('depositQueues')">
                                                            <i data-lucide="plus"></i>
                                                        </button>
                                                    </div>
                                                </td>
                                            </tr>
                                            <tr>
                                                <td>Очереди на вывод</td>
                                                <td>
                                                    <div class="number-input-group">
                                                        <button type="button" class="btn-icon" onclick="trafficCalc.decrementManualValue('withdrawalQueues')">
                                                            <i data-lucide="minus"></i>
                                                        </button>
                                                        <input type="number" id="withdrawalQueues" value="0" min="0" onchange="trafficCalc.saveCurrentManualDataStep6()">
                                                        <button type="button" class="btn-icon" onclick="trafficCalc.incrementManualValue('withdrawalQueues')">
                                                            <i data-lucide="plus"></i>
                                                        </button>
                                                    </div>
                                                </td>
                                            </tr>
                                            <tr>
                                                <td>Зачисление вне лимитов</td>
                                                <td>
                                                    <div class="number-input-group">
                                                        <button type="button" class="btn-icon" onclick="trafficCalc.decrementManualValue('creditsOutsideLimits')">
                                                            <i data-lucide="minus"></i>
                                                        </button>
                                                        <input type="number" id="creditsOutsideLimits" value="0" min="0" onchange="trafficCalc.saveCurrentManualDataStep6()">
                                                        <button type="button" class="btn-icon" onclick="trafficCalc.incrementManualValue('creditsOutsideLimits')">
                                                            <i data-lucide="plus"></i>
                                                        </button>
                                                    </div>
                                                </td>
                                            </tr>
                                            <tr>
                                                <td>Одобрение неверной суммы</td>
                                                <td>
                                                    <div class="number-input-group">
                                                        <button type="button" class="btn-icon" onclick="trafficCalc.decrementManualValue('wrongAmountApproval')">
                                                            <i data-lucide="minus"></i>
                                                        </button>
                                                        <input type="number" id="wrongAmountApproval" value="0" min="0" onchange="trafficCalc.saveCurrentManualDataStep6()">
                                                        <button type="button" class="btn-icon" onclick="trafficCalc.incrementManualValue('wrongAmountApproval')">
                                                            <i data-lucide="plus"></i>
                                                        </button>
                                                    </div>
                                                </td>
                                            </tr>
                                            <tr>
                                                <td>Другие нарушения</td>
                                                <td>
                                                    <div class="number-input-group">
                                                        <button type="button" class="btn-icon" onclick="trafficCalc.decrementManualValue('otherViolations')">
                                                            <i data-lucide="minus"></i>
                                                        </button>
                                                        <input type="number" id="otherViolations" value="0" min="0" onchange="trafficCalc.saveCurrentManualDataStep6()">
                                                        <button type="button" class="btn-icon" onclick="trafficCalc.incrementManualValue('otherViolations')">
                                                            <i data-lucide="plus"></i>
                                                        </button>
                                                    </div>
                                                    <textarea id="otherViolationsDescription" placeholder="Опишите нарушения..." rows="2" style="width: 100%; margin-top: 8px; resize: vertical;" onchange="trafficCalc.saveCurrentManualDataStep6()"></textarea>
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>

                        <!-- Правая часть: Выбор субагента -->
                        <div class="manual-data-selector">
                            <div class="form-group">
                                <label for="partnerSearchInput6">Поиск субагента</label>
                                <input type="text" id="partnerSearchInput6" placeholder="Введите название субагента" oninput="trafficCalc.filterPartnersListStep6()">
                            </div>

                            <div class="form-group">
                                <label for="partnerSelectList6">Выберите субагента</label>
                                <select id="partnerSelectList6" size="10" onchange="trafficCalc.loadPartnerManualDataStep6()">
                                    <option value="">Сначала выберите партнеров на шаге 1</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="step-navigation">
                        <button class="btn btn-secondary" onclick="trafficCalc.goToStep(5)">
                            <i data-lucide="arrow-left"></i> Назад
                        </button>
                        <button id="step6NextBtn" class="btn btn-success" onclick="trafficCalc.completeAnalytics()">
                            <i data-lucide="check"></i> Завершить
                        </button>
                    </div>
                </div>
            </div>


        </div>

        <!-- Вкладка: Отчет -->
        <div id="reportTab" class="tab-content">
            <div class="section">
                <div class="section-header">
                    <h2>Формирование отчета</h2>
                    <button class="btn btn-primary" onclick="trafficCalc.generateReport()">
                        <i data-lucide="file-plus"></i> Сформировать отчет
                    </button>
                </div>
                
                <div id="reportNotGenerated" class="report-placeholder">
                    <div class="report-placeholder-content">
                        <i data-lucide="file-text" style="width: 48px; height: 48px; color: #999;"></i>
                        <p>Отчет не сформирован</p>
                        <p class="report-hint">Перейдите на вкладку "Аналитика", выберите партнеров и вернитесь сюда для формирования отчета</p>
                    </div>
                </div>

                <div id="reportGenerated" class="report-generated" style="display: none;">
                    <div class="report-summary">
                        <h3>Сводка</h3>
                        <div class="report-stats">
                            <div class="stat-card">
                                <div class="stat-value" id="reportTotalCount">0</div>
                                <div class="stat-label">Всего субагентов</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value" id="reportNewCount">0</div>
                                <div class="stat-label">Новых</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value" id="reportOldCount">0</div>
                                <div class="stat-label">Старых</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value" id="reportClosedCount">0</div>
                                <div class="stat-label">Закрытых</div>
                            </div>
                        </div>
                    </div>

                    <div class="section-header">
                        <h3>Детальный отчет</h3>
                        <div>
                            <button class="btn btn-success" onclick="trafficCalc.exportReportToExcel()">
                                <i data-lucide="download"></i> Экспорт в Excel
                            </button>
                            <button class="btn btn-primary" onclick="trafficCalc.openTrafficCalculator()">
                                <i data-lucide="calculator"></i> Рассчитать % трафика
                            </button>
                        </div>
                    </div>

                    <div class="table-wrapper">
                        <table class="partners-table">
                            <thead>
                                <tr>
                                    <th>Метод</th>
                                    <th>Субагент</th>
                                    <th>Субагент ID</th>
                                    <th>Статус</th>
                                    <th>Дата добавления</th>
                                    <th>Back</th>
                                    <th>Cringe</th>
                                    <th>Автоотключение</th>
                                    <th>Кол-во пополнений</th>
                                    <th>Кол-во выводов</th>
                                    <th>Обращений по пополнениям</th>
                                    <th>Обращения 15+ мин</th>
                                    <th>% успешных пополнений</th>
                                    <th>% успешных выводов</th>
                                    <th>% Времени работы на пополнения</th>
                                    <th>% Времени работы на вывод</th>
                                    <th>Игнорирование чатов</th>
                                    <th>Игнор Webmanagement</th>
                                    <th>Очереди на пополнение</th>
                                    <th>Очереди на вывод</th>
                                    <th>Зачисление вне лимитов</th>
                                    <th>Одобрение неверной суммы</th>
                                    <th>Другие нарушения</th>
                                </tr>
                            </thead>
                            <tbody id="reportTableBody">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Модальное окно детального отчета -->
        <div id="detailedReportModal" class="modal modal-large">
            <div class="modal-dialog modal-dialog-large">
                <div class="modal-header">
                    <h2>Детальный отчет</h2>
                    <button class="modal-close" onclick="trafficCalc.closeDetailedReport()">
                        <i data-lucide="x"></i>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="table-wrapper">
                        <table class="partners-table">
                            <thead>
                                <tr>
                                    <th>Метод</th>
                                    <th>Субагент</th>
                                    <th>Субагент ID</th>
                                    <th>Статус</th>
                                    <th>Дата добавления</th>
                                    <th>Back</th>
                                    <th>Cringe</th>
                                    <th>Автоотключение</th>
                                    <th>Кол-во пополнений</th>
                                    <th>Кол-во выводов</th>
                                    <th>Обращений по пополнениям</th>
                                    <th>Обращения 15+ мин</th>
                                    <th>% успешных пополнений</th>
                                    <th>% успешных выводов</th>
                                    <th>% Времени работы на пополнения</th>
                                    <th>% Времени работы на вывод</th>
                                    <th>Игнорирование чатов</th>
                                    <th>Игнор Webmanagement</th>
                                    <th>Очереди на пополнение</th>
                                    <th>Очереди на вывод</th>
                                    <th>Зачисление вне лимитов</th>
                                    <th>Одобрение неверной суммы</th>
                                    <th>Другие нарушения</th>
                                </tr>
                            </thead>
                            <tbody id="detailedReportTableBody">
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" onclick="trafficCalc.closeDetailedReport()">Закрыть</button>
                </div>
            </div>
        </div>

        <!-- Модальное окно редактирования партнера -->
        <div id="editModal" class="modal">
            <div class="modal-dialog">
                <div class="modal-header">
                    <h2>Редактировать партнера</h2>
                    <button class="modal-close" onclick="trafficCalc.closeEditModal()">
                        <i data-lucide="x"></i>
                    </button>
                </div>
                <div class="modal-body">
                    <form id="editForm">
                        <input type="hidden" id="editPartnerId">
                        
                        <div class="form-group">
                            <label for="editMethodSelect">Метод</label>
                            <select id="editMethodSelect" required>
                                <option value="">Выберите метод</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="editSubagentInput">Субагент</label>
                            <input type="text" id="editSubagentInput" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="editSubagentIdInput">Субагент ID</label>
                            <input type="text" id="editSubagentIdInput" required>
                        </div>

                        <div class="form-group">
                            <label for="editStatusSelect">Статус</label>
                            <select id="editStatusSelect" required>
                                <option value="новый">Новый</option>
                                <option value="старый">Старый</option>
                                <option value="закрыт">Закрыт</option>
                            </select>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" onclick="trafficCalc.closeEditModal()">Отмена</button>
                    <button class="btn btn-primary" onclick="trafficCalc.saveEdit()">Сохранить</button>
                </div>
            </div>
        </div>

        <!-- Модальное окно управления методами -->
        <div id="methodModal" class="modal">
            <div class="modal-dialog">
                <div class="modal-header">
                    <h2>Управление методами</h2>
                    <button class="modal-close" onclick="trafficCalc.closeMethodModal()">
                        <i data-lucide="x"></i>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label for="newMethodInput">Добавить новый метод</label>
                        <div style="display: flex; gap: 8px;">
                            <input type="text" id="newMethodInput" placeholder="Название метода">
                            <button class="btn btn-primary" onclick="trafficCalc.addMethod()">
                                <i data-lucide="plus"></i> Добавить
                            </button>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Существующие методы</label>
                        <div id="methodsList" class="methods-list"></div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" onclick="trafficCalc.closeMethodModal()">Закрыть</button>
                </div>
            </div>
        </div>

        <!-- Модальное окно калькулятора трафика -->
        <div id="trafficCalculatorModal" class="modal modal-xlarge">
            <div class="modal-dialog modal-dialog-xlarge">
                <div class="modal-header">
                    <h2>Настройки расчета % трафика</h2>
                    <button class="modal-close" onclick="trafficCalc.closeTrafficCalculator()">
                        <i data-lucide="x"></i>
                    </button>
                </div>
                <div class="modal-body">
                    <p class="modal-description">Укажите диапазоны значений и баллы для каждого параметра</p>
                    
                    <div id="trafficSettingsForm" class="traffic-settings-form">
                        <!-- Параметры будут добавлены динамически через JS -->
                    </div>
                </div>
                <div class="modal-footer" style="display: flex; justify-content: space-between; align-items: center;">
                    <div style="display: flex; gap: 8px;">
                        <button class="btn" style="background: #ff9800; color: white; border: 1px solid #f57c00;" onclick="trafficCalc.exportTrafficSettings()" title="Экспортировать настройки">
                            <i data-lucide="download"></i> Экспорт настроек
                        </button>
                        <button class="btn" style="background: #2196f3; color: white; border: 1px solid #1976d2;" onclick="trafficCalc.importTrafficSettings()" title="Импортировать настройки">
                            <i data-lucide="upload"></i> Импорт настроек
                        </button>
                    </div>
                    <div style="display: flex; gap: 8px;">
                        <button class="btn btn-secondary" onclick="trafficCalc.closeTrafficCalculator()">Отмена</button>
                        <button class="btn btn-success" onclick="trafficCalc.calculateTraffic()">
                            <i data-lucide="play"></i> Рассчитать
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Модальное окно результатов расчета -->
        <div id="trafficResultsModal" class="modal modal-large">
            <div class="modal-dialog modal-dialog-large">
                <div class="modal-header">
                    <h2>Результаты расчета % трафика</h2>
                    <button class="modal-close" onclick="trafficCalc.closeTrafficResults()">
                        <i data-lucide="x"></i>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="table-wrapper">
                        <table class="partners-table traffic-results-table">
                            <thead>
                                <tr>
                                    <th>Метод</th>
                                    <th>Субагент</th>
                                    <th>ID Субагента</th>
                                    <th class="score-good">Хороший</th>
                                    <th class="score-normal">Нормальный</th>
                                    <th class="score-bad">Плохой</th>
                                    <th class="score-terrible">Ужасный</th>
                                    <th class="score-total">Всего</th>
                                    <th class="traffic-percent-header">% Трафика</th>
                                </tr>
                            </thead>
                            <tbody id="trafficResultsTableBody">
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" onclick="trafficCalc.closeTrafficResults()">Закрыть</button>
                    <button class="btn btn-primary" onclick="trafficCalc.exportTrafficResults()">
                        <i data-lucide="download"></i> Экспорт в Excel
                    </button>
                </div>
            </div>
        </div>

        <!-- Модальное окно импорта партнеров -->
        <div id="importPartnersModal" class="modal">
            <div class="modal-dialog">
                <div class="modal-header">
                    <h2>Импорт списка партнеров</h2>
                    <button class="modal-close" onclick="trafficCalc.closeImportModal()">
                        <i data-lucide="x"></i>
                    </button>
                </div>
                <div class="modal-body">
                    <p style="margin-bottom: 12px; color: #666;">Выберите JSON файл с данными партнеров для импорта:</p>
                    <input type="file" id="importPartnersFileInput" accept=".json" style="margin-bottom: 12px;">
                    <div id="importPartnersPreview" style="display: none; padding: 8px; background: #f0f0f0; border-radius: 4px; margin-bottom: 12px; font-size: 0.875rem;"></div>
                    <div style="padding: 12px; background: #fff3cd; border-radius: 4px; margin-top: 12px;">
                        <p style="margin: 0; font-size: 0.875rem; color: #856404;">
                            <strong>Важно:</strong> При импорте все текущие партнеры будут заменены на данные из файла. Рекомендуется сначала создать резервную копию через экспорт.
                        </p>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" onclick="trafficCalc.closeImportModal()">Отмена</button>
                    <button class="btn btn-primary" onclick="trafficCalc.importPartners()" id="importPartnersBtn" disabled>Импортировать</button>
                </div>
            </div>
        </div>
    </div>

    <script src="../shared/storage.js"></script>
    <script src="js/storage.js"></script>
    <script src="js/traffic-calculation.js"></script>
    <script>
        if (typeof lucide !== 'undefined') {
            lucide.createIcons();
        }
    </script>
</body>
</html>